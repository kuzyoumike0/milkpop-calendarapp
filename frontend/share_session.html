
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>共有リンク先 - MilkPop</title>
  <link rel="stylesheet" href="assets/styles.css"/>
</head>
<body>
  <div class="wrapper">
    <div class="nav">
      <div class="brand"><div class="logo"></div><h1>共有リンク先</h1></div>
      <div class="row">
        <a class="btn" href="index.html">トップ</a>
        <a class="btn" href="shared_setup.html">共有設定</a>
        <a class="btn" href="personal.html">個人スケジュール</a>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2 id="title">読み込み中…</h2>
        <div class="small" id="dates"></div>
        <hr class="sep"/>
        <div class="stack">
          <label>お名前</label>
          <input id="name" type="text" placeholder="あなたの名前"/>
          <label>方法</label>
          <div class="row">
            <label class="small"><input type="radio" name="mode" value="x" checked> ×</label>
            <label class="small"><input type="radio" name="mode" value="am"> 午前</label>
            <label class="small"><input type="radio" name="mode" value="pm"> 午後</label>
            <label class="small"><input type="radio" name="mode" value="allday"> 終日</label>
            <label class="small"><input type="radio" name="mode" value="time"> 時間指定</label>
          </div>
          <div class="row">
            <select id="start">
              <option value="">開始</option>
              ${["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"].map(t=>`<option>${t}</option>`).join("")}
            </select>
            <select id="end">
              <option value="">終了</option>
              ${["01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","24:00"].map(t=>`<option>${t}</option>`).join("")}
            </select>
          </div>
          <label>メモ</label>
          <textarea id="memo" placeholder="補足など"></textarea>
          <label>対象日</label>
          <select id="target"></select>
          <div><button class="btn" id="add">登録</button></div>
        </div>
      </div>
      <div class="card">
        <h2>登録一覧</h2>
        <div class="small">日付順で表示</div>
        <div id="list" class="list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { api, buildTimeSlot } from './assets/api.js';

    const params = new URLSearchParams(location.search);
    const token = params.get('token') || '';
    const titleEl = document.querySelector('#title');
    const datesEl = document.querySelector('#dates');
    const target = document.querySelector('#target');
    const list = document.querySelector('#list');

    let allowed = [];
    async function load() {
      if (!token) { titleEl.textContent = 'tokenがありません'; return; }
      const s = await api('/api/shared/session/'+token);
      titleEl.textContent = s.title;
      allowed = s.allowed_dates || [];
      datesEl.textContent = '候補日: ' + allowed.join(', ');
      target.innerHTML = allowed.map(d=>`<option>${d}</option>`).join('');
      await refreshList();
    }

    async function refreshList(){
      const rows = await api('/api/shared/session/'+token+'/events');
      list.innerHTML = rows.map(r=>`
        <div class="item">
          <div>
            <div><b>${r.date}</b> — ${r.member_name || '-'}</div>
            <div class="meta">${r.time_slot}${r.memo ? ' / '+r.memo : ''}</div>
          </div>
          <button class="btn secondary" data-del="${r.id}" data-name="${r.member_name}">削除</button>
        </div>
      `).join('');
    }

    document.querySelector('#add').addEventListener('click', async ()=>{
      const member_name = document.querySelector('#name').value.trim();
      if (!member_name) return alert('名前を入力してください');
      const mode = document.querySelector('input[name="mode"]:checked').value;
      const start = document.querySelector('#start').value;
      const end = document.querySelector('#end').value;
      const memo = document.querySelector('#memo').value.trim();
      const date = target.value;
      try{
        const slot = buildTimeSlot(mode, start, end);
        await api('/api/shared/session/'+token+'/register', { method:'POST', body: JSON.stringify({ date, time_slot: slot, member_name, memo }) });
        await refreshList();
      }catch(e){ alert('登録失敗: '+e.message); }
    });

    list.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-del]');
      if (!btn) return;
      const id = btn.dataset.del;
      const member_name = btn.dataset.name;
      if (!confirm('削除しますか？')) return;
      try{
        await api('/api/shared/session/'+token+'/events/'+id, { method:'DELETE', body: JSON.stringify({ member_name }) });
        await refreshList();
      }catch(e){ alert('削除失敗: '+e.message); }
    });

    load();
  </script>
</body>
</html>
